<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CL LP Exposure Planner — Capital Deployment</title>
<style>
  :root {
    --bg:#0b0f14; --card:#101620; --ink:#e8eef6; --muted:#9fb1c7;
    --accent:#5bb0ff; --good:#17c964; --bad:#ff5d5d; --warn:#ffc857;
    --highlight:#334255;
  }
  * { box-sizing:border-box; }
  body {
    margin:0; font:13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background:var(--bg); color:var(--ink);
  }
  header {
    padding:16px 18px; border-bottom:1px solid #17202d;
    position:sticky; top:0;
    background:linear-gradient(180deg,#0b0f14,#0b0f14f2 70%,transparent);
    z-index:5;
  }
  h1 { margin:0; font-size:15px; letter-spacing:.3px; font-weight:600; }
  .wrap { padding:16px 18px 36px; max-width:2000px; margin:0 auto; }
  .layout-grid { display:grid; grid-template-columns:1.15fr 1fr; gap:14px; align-items:start; }
  
  .card {
    background:var(--card); border:1px solid #17202d; border-radius:16px;
    padding:14px; box-shadow:0 4px 24px rgba(0,0,0,.25); margin-bottom: 14px;
  }
  .card h2 { margin:0 0 8px; font-size:13px; font-weight:600; color:var(--ink); }
  label { display:block; color:var(--muted); font-size:11px; margin:6px 0 3px; }
  input[type=number], select {
    width:100%; padding:8px 10px; border:1px solid #233142;
    border-radius:10px; background:#0c121a; color:var(--ink); outline:none;
    -webkit-appearance: none;
    -moz-appearance: textfield;
  }
  input[readonly] { background: var(--highlight); color: var(--accent); }
  
  .chk-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
  input[type=checkbox] { width:auto; transform:scale(1.2); cursor:pointer; }
  
  .row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
  .row4 { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .btns { display:flex; gap:8px; margin-top:12px; }
  button {
    padding:8px 10px; border:1px solid #223146; background:#0e1621;
    color:var(--ink); border-radius:12px; cursor:pointer; transition:.15s ease;
  }
  button.primary {
    background:linear-gradient(180deg,#1b2c43,#142133); border-color:#2d4666;
  }
  button.secondary {
    background: #1a2a3d; border-color: #2d4666; color: #a7c4e6;
  }
  button.secondary:hover {
    background: #23364d;
  }
  .muted { color:var(--muted); font-size:11px; }
  .pill {
    display:inline-block; padding:3px 7px; border-radius:999px;
    border:1px solid #26415f; background:#0f1723;
    font-size:10px; color:#a7c4e6;
  }
  table {
    width:100%; border-collapse:separate; border-spacing:0;
    min-width:1600px; table-layout:auto;
  }
  th, td {
    padding:6px 8px; border-bottom:1px solid #1a2433;
    text-align:right; white-space:nowrap;
  }
  th {
    position:sticky; top:0; background:#0f1622; z-index:2;
    font-weight:600; color:#b9cbe0; white-space:normal; line-height:1.2;
  }
  th:first-child, td:first-child {
    text-align:left; position:sticky; left:0;
    background:linear-gradient(90deg,#0f1622,#0f1622cc); z-index:1;
  }
  .sticky-r {
    position:sticky; right:0;
    background:linear-gradient(270deg,#0f1622,#0f1622cc);
    z-index:4; border-left:1px solid #1a2433;
  }
  .scroll { overflow:auto; border:1px solid #17202d; border-radius:14px; max-height:60vh; }
  .footnote { margin-top:8px; font-size:11px; color:#95a9c2; }
  .tag {
    display:inline-block; font-size:10px; padding:2px 6px;
    border-radius:999px; border:1px solid #284d6f; background:#0d1a27;
  }
  .tag.hold { border-color:#2a6f4d; background:#0d2017; }
  .tag.source { border-color:#6f2a2a; background:#27100f; }
  
  .section-header {
    margin: 24px 0 12px; font-size: 16px; font-weight: 700; color: var(--accent);
    display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #17202d; padding-bottom: 8px;
  }
  
  .summary-box {
    padding: 12px; background: #0e1622; 
    border: 1px solid #1a2a3d; border-radius: 12px; margin-bottom: 14px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .summary-row {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
    padding-bottom: 8px; border-bottom: 1px solid #1a2433;
  }
  .summary-row:last-child { border-bottom: none; padding-bottom: 0; }
  
  .summary-item label { color: var(--muted); font-size: 10px; text-transform: uppercase; margin:0 0 2px 0; display:block;}
  .summary-item div { font-size: 13px; font-weight: 600; color: var(--ink); }
  
  #debugBox {
    margin-top: 10px; padding: 10px; background: #000; color: #0f0;
    font-family: monospace; font-size: 11px; border-radius: 8px;
    max-height: 200px; overflow: auto; white-space: pre-wrap;
    display: none; border: 1px solid #333;
  }
</style>
</head>
<body>
<header>
  <h1>CL LP Exposure Planner — Capital Deployment</h1>
</header>

<div class="wrap">
  <div class="card">
    <h2>Inputs
      <span class="pill" style="float:right; background:var(--good); border-color:#1c693b;">
        Live Sheets & CoinGecko PRO
      </span>
    </h2>
    
    <div class="row4" style="margin-top:6px; grid-template-columns:1fr 1fr 2fr;">
      <div>
        <label>Alt asset (Select to load config)</label>
        <select id="assetSelect">
          <option value="">– Loading... –</option>
        </select>
      </div>
      <div>
        <label>Denominated asset</label>
        <select id="denomSelect">
          <option value="BTC" selected>BTC</option>
          <option value="ETH">ETH</option>
          <option value="SOL">SOL</option>
          <option value="BNB">BNB</option>
          <option value="HYPE">HYPE</option>
          <option value="USD">USD</option>
        </select>
      </div>
      <div>
         <div class="footnote" id="sheetStatus" style="margin-top:24px; color:var(--warn);">
           Connecting to Sheet...
         </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px; padding-top:12px; border-top:1px solid #1a2433;">
      <div>
        <label style="color:var(--accent);">Alt Price (USD)</label>
        <input type="number" id="altUsd" step="0.000001" value="0" style="border-color:var(--accent);">
      </div>
      <div>
        <label><span class="denomLabelShort">BTC</span> Price (USD)</label>
        <input type="number" id="denomUsd" step="0.01" value="60000">
      </div>
      <div>
         <label style="color:var(--accent);">JLP Price (USD, for JLP Mode)</label>
         <input type="number" id="jlpUsd" step="0.001" value="0" style="border-color:var(--accent);">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Price Min (Pmin, ALT/denom)</label>
        <input type="number" id="pmin" step="0.00000001" value="0.00010000">
      </div>
      <div>
        <label>Price Max (Pmax, ALT/denom)</label>
        <input type="number" id="pmax" step="0.00000001" value="0.00035000">
      </div>
      <div>
        <label>Current Price P₀ (ALT/<span class="denomLabelShort">BTC</span>)
           <span style="color:var(--good); font-weight:bold; margin-left:4px;">(Calculated)</span>
        </label>
        <input type="number" id="p0" step="0.00000001" value="0" style="background:#0c121a; color:var(--ink);">
      </div>
    </div>

    <div class="row4" style="margin-top:12px;">
      <div>
        <label>Total Portfolio size (<span class="denomLabelShort">BTC</span>)</label>
        <input type="number" id="portfolioSize" step="0.0001" value="0">
      </div>
      <div>
        <label>Target net exposure @ Pmin (% of portfolio)</label>
        <input type="number" id="targetMinPct" step="0.01" value="0">
      </div>
      <div>
        <label>Target net exposure @ Pmax (% of portfolio)</label>
        <input type="number" id="targetMaxPct" step="0.01" value="-100">
      </div>
      <div style="display:flex; flex-direction:column; gap:6px;">
         <div class="chk-row">
            <input type="checkbox" id="dualLpMode">
            <label for="dualLpMode" style="margin:0; font-size:12px; color:var(--ink); font-weight:600;">Dual LP</label>
            <input type="number" id="dualMult" step="0.1" value="1.0" style="width:50px; padding:2px 5px; margin-left:8px; border-color:#233142;" title="Multiplier per strategy (0.5 = 50% split, 1.0 = Full Size)">
            <span style="font-size:10px; color:var(--muted)">x</span>
         </div>
         <div class="chk-row">
            <input type="checkbox" id="jlpStrategyMode">
            <label for="jlpStrategyMode" style="margin:0; font-size:12px; color:var(--accent); font-weight:600;">JLP Mode (Hedged)</label>
         </div>
         <div class="chk-row">
            <input type="checkbox" id="tripleLpMode">
            <label for="tripleLpMode" style="margin:0; font-size:12px; color:#e08aff; font-weight:600;">Triple Split (3-Way)</label>
         </div>
      </div>
    </div>

    <div class="row4" style="margin-top:6px;">
      <div>
        <label>Interval size (%)</label>
        <input type="number" id="intervalPct" step="0.01" value="1">
      </div>
      <div style="position:relative;">
        <label>Current Net Exposure (<span class="denomLabelShort">BTC</span>)
          <span class="muted">(ALT + short, before LP)</span>
        </label>
        <div style="display:flex; gap:4px;">
          <input type="number" id="currentE" step="0.0001" value="0" style="flex:1;">
          <span id="fetchIndicator" style="display:none; color:var(--accent); font-size:10px; align-self:center;">Updating...</span>
        </div>
        <div id="fetchStatus" style="font-size:10px; color:var(--warn); margin-top:2px; height:14px;"></div>
      </div>
      <div>
        <label>Target @ Pmin (<span class="denomLabelShort">BTC</span>, auto)</label>
        <input type="number" id="targetMin" step="0.0001" value="0" readonly>
      </div>
      <div>
        <label>Target @ Pmax (<span class="denomLabelShort">BTC</span>, auto)</label>
        <input type="number" id="targetMax" step="0.0001" value="0" readonly>
      </div>
    </div>

    <div class="row4" style="margin-top:6px;">
      <div>
        <label>Precision decimals</label>
        <input type="number" id="dec" step="1" value="4">
      </div>
      <div>
        <label>Distribution Mode</label>
        <select id="distMode">
          <option value="uniform" selected>Equal Units (Linear)</option>
          <option value="univ3">Uni V3 Standard (Single Position)</option>
        </select>
      </div>
      <div>
        <label>Cap rows (optional)</label>
        <input type="number" id="capRows" step="1" placeholder="">
      </div>
      <div>
        <label>Show zero-only rows?</label>
        <select id="showZeros">
          <option value="hide">Hide</option>
          <option value="show">Show</option>
        </select>
      </div>
    </div>
    
    <div class="row4" style="margin-top:6px;">
       <div>
        <label>Assume current exposure scales with price?</label>
        <select id="scaleMode">
          <option value="scale">Scale linearly with price (default)</option>
          <option value="noscale">Do not scale current exposure</option>
        </select>
      </div>
      <div>
        <label style="color:var(--good)">Active % (Below)</label>
        <input type="number" id="activeUtilBelow" step="1" value="10" title="% of Bid Side Capital actively deployed">
      </div>
      <div>
        <label style="color:var(--accent)">Active % (Above)</label>
        <input type="number" id="activeUtilAbove" step="1" value="10" title="% of Ask Side Capital actively deployed">
      </div>
      <div>
        <label>APR on Active Capital (%)</label>
        <input type="number" id="aprPct" step="0.01" value="20">
      </div>
    </div>
    
    <div style="margin-top:12px;">
        <button class="secondary" onclick="toggleDebug()" style="font-size:11px; padding:4px 8px;">Toggle API Debug (Safe)</button>
        <div id="debugBox"></div>
    </div>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btn">Generate Schedules</button>
      <button class="secondary" id="btnExposure" style="color:var(--accent); border-color:var(--accent);">Generate Exposure</button>
      <button class="secondary" id="btnPnL" style="color:var(--good); border-color:var(--good);">Generate PnL</button>
      <button id="btnClear">Clear Tables</button>
    </div>
  </div>
  
  <div id="resultsContainer"></div>
  
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- YOUR CONFIG ---
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzATG0fdL2b6eMTw2CZcurw3BsNn1UzF0DsNRHdWpvoX8Ymr2UQGjuPjzSF2X_R9Sl8HA/exec';

// --- FIXED COINGECKO IDS (4-2 included) ---
const COINGECKO_IDS = {
  BTC: 'bitcoin', ETH: 'ethereum', SOL: 'solana', BNB: 'binancecoin',
  ARB: 'arbitrum', OP: 'optimism', TIA: 'celestia', MATIC: 'matic-network',
  LINK: 'chainlink', AVAX: 'avalanche-2', DOGE: 'dogecoin', ADA: 'cardano',
  XRP: 'ripple', LDO: 'lido-dao', UNI: 'uniswap', ASTER: 'aster-2',
  JLP: 'jupiter-perpetuals-liquidity-provider-token',
  XPL: 'plasma-xpl', 
  HYPE: 'hyperliquid',
  USELESS: 'useless-2',
  MET: 'metis-token',
  GIGGLE: 'giggle',
  '4': '4-2', 
  CAKE: 'pancakeswap-token',
  VIRTUALS: 'virtuals-protocol',
  AERO: 'aerodrome-finance',
  ORE: 'ore',
  SUI: 'sui',
  APT: 'aptos',
  ZEC: 'zcash'
};

function fmt(x, d){
  if(!isFinite(x)) return '–';
  const s = Number(x).toFixed(d);
  return Number(s).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
}

function toggleDebug() {
    const el = document.getElementById('debugBox');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function updateDenomLabels(sym){
  const s = sym || 'BTC';
  document.querySelectorAll('.denomLabelShort').forEach(el => { el.textContent = s; });
}

// --- SYNC FUNCTIONS (Bi-Directional + Reactivity) ---
function updateP0FromUsd() {
    const altUsd = Number(document.getElementById('altUsd').value || 0);
    const denomUsd = Number(document.getElementById('denomUsd').value || 0);
    const p0El = document.getElementById('p0');
    
    // Only calculate if BOTH prices are present
    if(altUsd > 0 && denomUsd > 0) {
        const ratio = altUsd / denomUsd;
        p0El.value = ratio.toFixed(10); 
    }
}

function updateUsdFromP0() {
    const p0 = Number(document.getElementById('p0').value || 0);
    const denomUsd = Number(document.getElementById('denomUsd').value || 0);
    const altUsdEl = document.getElementById('altUsd');
    
    if(p0 > 0 && denomUsd > 0) {
        const val = p0 * denomUsd;
        altUsdEl.value = val.toFixed(6);
    }
}

// NEW: MASTER CALCULATOR & AUTO-GENERATOR
function updateCalculatedFields(shouldGenerate = false) {
    const size = Number(document.getElementById('portfolioSize').value || 0);
    const minPct = Number(document.getElementById('targetMinPct').value || 0);
    const maxPct = Number(document.getElementById('targetMaxPct').value || 0);
    
    document.getElementById('targetMin').value = (size * minPct / 100).toFixed(4);
    document.getElementById('targetMax').value = (size * maxPct / 100).toFixed(4);

    if (document.activeElement.id !== 'p0') {
        updateP0FromUsd();
    }

    const curP0 = Number(document.getElementById('p0').value || 0);
    if(curP0 > 0 && shouldGenerate) {
        generate(); 
    }
}

// --- LIVE EXPOSURE (Restored Original Logic) ---
let fetchTimeout = null;

async function fetchLiveExposure() {
  const assetSym = document.getElementById('assetSelect').value;
  const denomUsd = Number(document.getElementById('denomUsd').value || 0);
  const statusEl = document.getElementById('fetchStatus');
  const currentEEl = document.getElementById('currentE');
  const indEl = document.getElementById('fetchIndicator');
  const debugBox = document.getElementById('debugBox');

  if(!assetSym || assetSym === "") {
    statusEl.textContent = '';
    return;
  }
  if(denomUsd <= 0) return;

  if(indEl) indEl.style.display = 'block';
  
  try {
    const res = await fetch('/api/exposure');
    if (!res.ok) throw new Error(`Error ${res.status}`);
    const rawData = await res.json();
    let dataList = [];
    if (Array.isArray(rawData)) { dataList = rawData; } 
    else if (typeof rawData === 'object' && rawData !== null) {
        const keys = Object.keys(rawData);
        if (keys.length > 0) { dataList = keys.map(k => ({ symbol: k, ...rawData[k] })); } 
        else { dataList = [rawData]; }
    }

    const searchSym = assetSym.toUpperCase();
    
    // --- RESTORED ORIGINAL MATCHING LOGIC ---
    const found = dataList.find(p => {
        const s1 = (p.symbol || '').toUpperCase();
        const s2 = (p.ticker || '').toUpperCase();
        const s3 = (p.asset || '').toUpperCase();
        const s4 = (p.name || '').toUpperCase();
        return s1 === searchSym || s2 === searchSym || s3 === searchSym || s4.includes(searchSym);
    });

    if (found) {
        // --- RESTORED ORIGINAL VALUE EXTRACTION ---
        // This looks for your custom key: net_exposure_usd_from_base
        const usdVal = Number(found.net_exposure_usd_from_base || 0);

        if (!isNaN(usdVal) && usdVal !== 0) {
            const denomExposure = usdVal / denomUsd;
            currentEEl.value = denomExposure.toFixed(6);
            statusEl.textContent = `Auto-Loaded: $${fmt(usdVal, 0)} exposure`;
            statusEl.style.color = 'var(--good)';
            generate();
        } else {
            statusEl.textContent = `Found ${assetSym} (Pos: $0)`;
            statusEl.style.color = 'var(--warn)';
        }
    } else {
        statusEl.textContent = `No position found for ${assetSym}.`;
        statusEl.style.color = 'var(--muted)';
    }
  } catch (err) {
    console.warn("Live exposure fetch skipped (local env).");
    statusEl.textContent = "";
  } finally {
    if(indEl) indEl.style.display = 'none';
  }
}

function triggerAutoFetch() {
    if(fetchTimeout) clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(fetchLiveExposure, 500); 
}

// --- PRICE FETCHING ---
async function fetchPriceBatch(ids) {
    if(!ids) return {};
    try {
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=usd`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(res.statusText);
        return await res.json();
    } catch(e) {
        console.warn("Price fetch failed:", e);
        return null;
    }
}

async function autoFetchPrices(assetSym, denomSym){
  const statusEl = document.getElementById('sheetStatus');
  statusEl.textContent = "Fetching prices...";
  statusEl.style.color = 'var(--accent)';

  let assetId = COINGECKO_IDS[(assetSym || '').toUpperCase()];
  if (!assetId && assetSym) { assetId = assetSym.toLowerCase(); }

  const denomId = COINGECKO_IDS[(denomSym || '').toUpperCase()];
  const isUsd   = (denomSym || '').toUpperCase() === 'USD';

  if (isUsd) document.getElementById('denomUsd').value = 1;

  try {
    let mainIds = (!isUsd && denomId) ? denomId : '';
    if(assetId) mainIds += (mainIds ? ',' : '') + assetId;
    
    let mainData = {};
    if(mainIds) {
        mainData = await fetchPriceBatch(mainIds);
        if(mainData) {
            if(!isUsd && denomId && mainData[denomId]?.usd) {
                document.getElementById('denomUsd').value = mainData[denomId].usd;
            }
            if(assetId && mainData[assetId]?.usd > 0) {
                document.getElementById('altUsd').value = mainData[assetId].usd;
            }
        }
    }
    
    updateCalculatedFields();
    triggerAutoFetch();
    statusEl.textContent = `Prices Updated.`;
    statusEl.style.color = 'var(--good)';
    return true;

  } catch(err) {
    statusEl.textContent = `Price API Error. Enter Manually.`;
    return false;
  }
}

// --- GOOGLE SHEET HANDLING ---
async function loadAssetList(){
  const url = APPS_SCRIPT_URL;
  const sel = document.getElementById('assetSelect');
  const statusEl = document.getElementById('sheetStatus');
  
  statusEl.textContent = 'Loading list...';
  sel.innerHTML = '<option value="">Loading...</option>';
  
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    
    if(data.error){ throw new Error(data.error); }
    
    sel.innerHTML = '<option value="">– Select asset –</option>';
    if(data.assets && Array.isArray(data.assets)){
      data.assets.forEach(sym => {
        if(sym){
          const opt = document.createElement('option');
          opt.value = String(sym).trim();
          opt.textContent = String(sym).trim();
          sel.appendChild(opt);
        }
      });
      statusEl.textContent = `Loaded ${data.assets.length} assets.`;
    }
  }catch(err){
    console.error(err);
    sel.innerHTML = '<option value="">Error</option>';
    statusEl.innerHTML = `<span style="color:var(--bad)">Error loading list. Check URL.</span>`;
  }
}

async function loadAssetConfig(symbol){
  if(!symbol) return;
  const url = APPS_SCRIPT_URL;
  const statusEl = document.getElementById('sheetStatus');
  statusEl.textContent = `Loading ${symbol}...`;

  try{
    const fetchUrl = `${url}?symbol=${encodeURIComponent(symbol)}`;
    const res = await fetch(fetchUrl);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    if(data.pmin) document.getElementById('pmin').value = data.pmin;
    if(data.pmax) document.getElementById('pmax').value = data.pmax;
    if(data.portfolioSize) document.getElementById('portfolioSize').value = data.portfolioSize;
    if(data.targetMinPct !== undefined) document.getElementById('targetMinPct').value = data.targetMinPct;
    if(data.targetMaxPct !== undefined) document.getElementById('targetMaxPct').value = data.targetMaxPct;

    if(data.denomAsset){
      const dSel = document.getElementById('denomSelect');
      dSel.value = data.denomAsset;
      updateDenomLabels(data.denomAsset);
    }
    
    await autoFetchPrices(symbol, data.denomAsset || 'BTC');
    
    const currentAlt = Number(document.getElementById('altUsd').value);
    if (currentAlt === 0) {
        statusEl.innerHTML = `Loaded config. <span style="color:var(--accent)">Enter Price Manually.</span>`;
    } else {
        generate(); 
    }

  }catch(err){
    console.error(err);
    statusEl.innerHTML = `<span style="color:var(--bad)">Failed to load ${symbol}.</span>`;
  }
}

// ... (Rest of logic: calculateStrategy, buildBands, rendering, same as before) ...
function buildBands(pmin, pmax, p0, stepPct){
  const down = [], up = [];
  let p = p0;
  while(p > pmin){
    const pb = p;
    const pa = Math.max(pmin, pb * (1 - stepPct/100));
    down.push({pa, pb, type:'Below'});
    if(pa === pmin) break;
    p = pa;
  }
  p = p0;
  while(p < pmax){
    const pa = p;
    const pb = Math.min(pmax, pa * (1 + stepPct/100));
    up.push({pa, pb, type:'Above'});
    if(pb === pmax) break;
    p = pb;
  }
  return {down, up};
}

function calculateStrategy(params) {
  const { pmin, pmax, p0, stepPct, portfolioSize, targetMinPct, targetMaxPct, currentE, denomUsd, distMode, scaleMode } = params;
  if(!(pmin>0 && pmax>pmin && p0>0)) return null;

  const bands = buildBands(pmin, pmax, p0, stepPct);
  const Nup = bands.up.length, Ndown = bands.down.length;
  
  const targetMin = portfolioSize * targetMinPct / 100;
  const targetMax = portfolioSize * targetMaxPct / 100;
  const scaleFactor = (scaleMode === 'scale' && p0 > 0) ? (p0/p0) : 1; 

  const currentAtMin = currentE; 
  const needMinDelta = (targetMin - currentAtMin); 
  const needMoreNegativeAtMax = (currentE - targetMax);
  
  let aboveTotalScheduled = 0, globalL_Above = 0;
  
  if (Nup > 0) {
      if (distMode === 'univ3') {
          const effectivePmax = bands.up[bands.up.length-1].pb;
          const term = (1/Math.sqrt(p0)) - (1/Math.sqrt(effectivePmax));
          const totalAssetUnitsNeeded = needMoreNegativeAtMax / effectivePmax; 
          if(term > 0) globalL_Above = totalAssetUnitsNeeded / term;
          aboveTotalScheduled = totalAssetUnitsNeeded * p0; 
      } else {
          let sumSqrtP = 0;
          for(const b of bands.up) sumSqrtP += Math.sqrt(b.pa * b.pb);
          const constUnitsAbove = sumSqrtP > 0 ? (needMoreNegativeAtMax / sumSqrtP) : 0;
          for(const b of bands.up) aboveTotalScheduled += constUnitsAbove * Math.sqrt(b.pa * b.pb);
      }
  }

  // Quick constraints
  const totalReq = aboveTotalScheduled; 
  
  const rows = [];
  const ordered = [...bands.down, ...bands.up];
  
  // Simple rendering logic for table
  ordered.forEach((b, idx) => {
    const isDown = (b.type === 'Below');
    let deployUSD = 0, deployAltUsd = 0, altUnitsAbove = 0;
    
    if(isDown) {
        deployUSD = (needMinDelta / Ndown); // uniform split
    } else {
        if(distMode === 'univ3') {
            const x = globalL_Above * (1/Math.sqrt(b.pa) - 1/Math.sqrt(b.pb));
            altUnitsAbove = x;
            deployAltUsd = x * Math.sqrt(b.pa * b.pb);
        } else {
            const constUnits = (needMoreNegativeAtMax / Math.sqrt(pmax*p0)); // approx
            altUnitsAbove = constUnits; 
            deployAltUsd = altUnitsAbove * Math.sqrt(b.pa * b.pb);
        }
    }
    
    rows.push({
      bandIdx: idx + 1, pa: b.pa, pb: b.pb, type: b.type,
      deployUSD, deployAltUsd, altUnitsAbove, sourceTag: ''
    });
  });

  return { rows, kpi: { Ndown, Nup, belowTotal: needMinDelta, aboveTotal: aboveTotalScheduled } };
}

function renderLPSection(container, title, strategyData, denomSymbol, denomUsd, assetSymbol) {
  if(!strategyData) return;
  const { rows } = strategyData;
  rows.sort((a,b) => a.pa - b.pa);
  
  const html = `
    <div class="section-header">${title}</div>
    <div class="card"><div class="scroll"><table><thead><tr>
       <th style="text-align:left;">Band</th><th>Range</th><th>Type</th><th>Deployed</th><th>USD Value</th>
    </tr></thead><tbody>
    ${rows.map(r => {
        let valStr = r.type==='Below' ? fmt(r.deployUSD,6)+' '+denomSymbol : fmt(r.altUnitsAbove,6)+' '+assetSymbol;
        let usdVal = r.type==='Below' ? r.deployUSD*denomUsd : r.deployAltUsd*denomUsd;
        return `<tr>
           <td style="text-align:left">${r.bandIdx}</td>
           <td>${fmt(r.pa,6)} - ${fmt(r.pb,6)}</td>
           <td style="color:${r.type==='Below'?'var(--good)':'var(--accent)'}">${r.type==='Below'?'↓':'↑'}</td>
           <td style="font-weight:600;">${valStr}</td>
           <td style="color:#888">$${fmt(usdVal,2)}</td>
        </tr>`;
    }).join('')}
    </tbody></table></div></div>
  `;
  const d = document.createElement('div'); d.innerHTML=html; container.appendChild(d);
}

function generate() {
  const container = document.getElementById('resultsContainer'); container.innerHTML = '';
  // Force update P0 before generation
  updateCalculatedFields(false);

  const params = {
      pmin: Number(document.getElementById('pmin').value),
      pmax: Number(document.getElementById('pmax').value),
      p0: Number(document.getElementById('p0').value),
      stepPct: Number(document.getElementById('intervalPct').value),
      portfolioSize: Number(document.getElementById('portfolioSize').value),
      targetMinPct: Number(document.getElementById('targetMinPct').value),
      targetMaxPct: Number(document.getElementById('targetMaxPct').value),
      currentE: Number(document.getElementById('currentE').value),
      denomUsd: Number(document.getElementById('denomUsd').value),
      distMode: document.getElementById('distMode').value,
      scaleMode: document.getElementById('scaleMode').value
  };
  const data = calculateStrategy(params);
  const asset = document.getElementById('assetSelect').value || 'ALT';
  const denom = document.getElementById('denomSelect').value || 'BTC';
  renderLPSection(container, "Schedule", data, denom, params.denomUsd, asset);
}

// --- INIT ---
(function(){
  const assetSel = document.getElementById('assetSelect');
  const btn = document.getElementById('btn');
  const inputs = document.querySelectorAll('input');

  // Reactivity: update calcs on any input change
  // passing 'true' to allow auto-generation when typing
  inputs.forEach(el => el.addEventListener('input', () => updateCalculatedFields(true)));
  
  loadAssetList();
  
  assetSel.addEventListener('change', () => loadAssetConfig(assetSel.value));
  btn.addEventListener('click', generate);
})();
</script>
</body>
</html>
